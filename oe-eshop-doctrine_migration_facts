#!/bin/bash

[ -z $ESHOP_FACTS ] && echo "Please run this script through oe-eshop-facts, e.g. ./oe-eshop-facts $0" && exit 1
. $ESHOP_FACT_BIN_PATH
. $ESHOP_VENDOR_BIN_PATH/oe-eshop-migration_facts

function main {
    get_input_values
    display_input_values
    export_input_values
}

function get_input_values {
    local DOCTRINE_MIGRATION_WRAPPER_VENDOR_DIR="eshop-doctrine-migration-wrapper"
    local DOCTRINE_BIN_FN="doctrine-migrations"
    local CONFIG_FN="migrations.yml"
    local DB_CONFIG_FN="migrations-db.php"
    local PROJECT_PREFIX="project"

    : ${ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH:=$(get_existing_full_path_name "$ESHOP_OXID_VENDOR_PATH/$DOCTRINE_MIGRATION_WRAPPER_VENDOR_DIR")}
    : ${ESHOP_DOCTRINE_MIGRATION_BIN_PATH:=$(get_existing_full_path_name "$ESHOP_VENDOR_BIN_PATH/$DOCTRINE_BIN_FN")}
    : ${ESHOP_DOCTRINE_CONFIG_FILENAME:="$CONFIG_FN"}
    : ${ESHOP_DOCTRINE_DB_CONFIG_FILENAME:="$DB_CONFIG_FN"}

    : ${ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH:=$(get_existing_full_path_name "$ESHOP_CE_MIGRATION_PATH/$ESHOP_DOCTRINE_CONFIG_FILENAME")}
    : ${ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH:=$(get_existing_full_path_name "$ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH/$ESHOP_DOCTRINE_DB_CONFIG_FILENAME")}
    : ${ESHOP_DOCTRINE_CE_MIGRATION_DATA_PATH:=$(get_migrations_data_path "$ESHOP_CE_MIGRATION_PATH" "$ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH")}
    : ${ESHOP_DOCTRINE_CE_HAS_MIGRATIONS:=$(has_migrations "$ESHOP_DOCTRINE_CE_MIGRATION_DATA_PATH")}

    : ${ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH:=$(get_existing_full_path_name "$ESHOP_PE_MIGRATION_PATH/$ESHOP_DOCTRINE_CONFIG_FILENAME")}
    : ${ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH:=$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH}
    : ${ESHOP_DOCTRINE_PE_MIGRATION_DATA_PATH:=$(get_migrations_data_path "$ESHOP_PE_MIGRATION_PATH" "$ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH")}
    : ${ESHOP_DOCTRINE_PE_HAS_MIGRATIONS:=$(has_migrations "$ESHOP_DOCTRINE_PE_MIGRATION_DATA_PATH")}

    : ${ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH:=$(get_existing_full_path_name "$ESHOP_EE_MIGRATION_PATH/$ESHOP_DOCTRINE_CONFIG_FILENAME")}
    : ${ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH:=$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH}
    : ${ESHOP_DOCTRINE_EE_MIGRATION_DATA_PATH:=$(get_migrations_data_path "$ESHOP_EE_MIGRATION_PATH" "$ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH")}
    : ${ESHOP_DOCTRINE_EE_HAS_MIGRATIONS:=$(has_migrations "$ESHOP_DOCTRINE_EE_MIGRATION_DATA_PATH")}

    : ${ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH:=$(get_existing_full_path_name "$ESHOP_PROJECT_MIGRATION_PATH/${PROJECT_PREFIX}_$ESHOP_DOCTRINE_CONFIG_FILENAME")}
    : ${ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH:=$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH}
    : ${ESHOP_DOCTRINE_PROJECT_MIGRATION_DATA_PATH:=$(get_migrations_data_path "$ESHOP_PROJECT_MIGRATION_PATH" "$ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH")}
    : ${ESHOP_DOCTRINE_PROJECT_HAS_MIGRATIONS:=$(has_migrations "$ESHOP_DOCTRINE_PROJECT_MIGRATION_DATA_PATH")}
}

function display_input_values {
    [ "$ESHOP_VERBOSE_DOCTRINE_MIGRATION_FACTS_DISPLAYED" == "1" ] && return 0

    if [ ! -z "$VERBOSE" ] || [ ! -z "$ESHOP_VERBOSE_DOCTRINE_MIGRATION_FACTS"] ; then
        print_variables_header "$BASH_SOURCE"
        echo -e "\tESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH: $ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH"
        echo -e "\tESHOP_DOCTRINE_MIGRATION_BIN_PATH: $ESHOP_DOCTRINE_MIGRATION_BIN_PATH"
        echo -e "\tESHOP_DOCTRINE_CONFIG_FILENAME: $ESHOP_DOCTRINE_CONFIG_FILENAME"
        echo -e "\tESHOP_DOCTRINE_DB_CONFIG_FILENAME: $ESHOP_DOCTRINE_DB_CONFIG_FILENAME"

        echo -e "\tESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_CE_MIGRATION_DATA_PATH: $ESHOP_DOCTRINE_CE_MIGRATION_DATA_PATH"
        echo -e "\tESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_CE_HAS_MIGRATIONS: $ESHOP_DOCTRINE_CE_HAS_MIGRATIONS"

        echo -e "\tESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_PE_MIGRATION_DATA_PATH: $ESHOP_DOCTRINE_PE_MIGRATION_DATA_PATH"
        echo -e "\tESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_PE_HAS_MIGRATIONS: $ESHOP_DOCTRINE_PE_HAS_MIGRATIONS"

        echo -e "\tESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_EE_MIGRATION_DATA_PATH: $ESHOP_DOCTRINE_EE_MIGRATION_DATA_PATH"
        echo -e "\tESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_EE_HAS_MIGRATIONS: $ESHOP_DOCTRINE_EE_HAS_MIGRATIONS"

        echo -e "\tESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_PROJECT_MIGRATION_DATA_PATH: $ESHOP_DOCTRINE_PROJECT_MIGRATION_DATA_PATH"
        echo -e "\tESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH"
        echo -e "\tESHOP_DOCTRINE_PROJECT_HAS_MIGRATIONS: $ESHOP_DOCTRINE_PROJECT_HAS_MIGRATIONS"
        echo ""

        ESHOP_VERBOSE_DOCTRINE_MIGRATION_FACTS_DISPLAYED="1"
        export ESHOP_VERBOSE_DOCTRINE_MIGRATION_FACTS_DISPLAYED="1"
    fi
}

function export_input_values {
    [ ! -z "$VERBOSE" ] && export VERBOSE="$VERBOSE"

    export ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH="$ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH"
    export ESHOP_DOCTRINE_MIGRATION_BIN_PATH="$ESHOP_DOCTRINE_MIGRATION_BIN_PATH"
    export ESHOP_DOCTRINE_CONFIG_FILENAME="$ESHOP_DOCTRINE_CONFIG_FILENAME"
    export ESHOP_DOCTRINE_DB_CONFIG_FILENAME="$ESHOP_DOCTRINE_DB_CONFIG_FILENAME"

    export ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH="$ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH"
    export ESHOP_DOCTRINE_CE_MIGRATION_DATA_PATH="$ESHOP_DOCTRINE_CE_MIGRATION_DATA_PATH"
    export ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH="$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH"
    export ESHOP_DOCTRINE_CE_HAS_MIGRATIONS="$ESHOP_DOCTRINE_CE_HAS_MIGRATIONS"

    export ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH="$ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH"
    export ESHOP_DOCTRINE_PE_MIGRATION_DATA_PATH="$ESHOP_DOCTRINE_PE_MIGRATION_DATA_PATH"
    export ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH="$ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH"
    export ESHOP_DOCTRINE_PE_HAS_MIGRATIONS="$ESHOP_DOCTRINE_PE_HAS_MIGRATIONS"

    export ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH="$ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH"
    export ESHOP_DOCTRINE_EE_MIGRATION_DATA_PATH="$ESHOP_DOCTRINE_EE_MIGRATION_DATA_PATH"
    export ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH="$ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH"
    export ESHOP_DOCTRINE_EE_HAS_MIGRATIONS="$ESHOP_DOCTRINE_EE_HAS_MIGRATIONS"

    export ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH="$ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH"
    export ESHOP_DOCTRINE_PROJECT_MIGRATION_DATA_PATH="$ESHOP_DOCTRINE_PROJECT_MIGRATION_DATA_PATH"
    export ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH="$ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH"
    export ESHOP_DOCTRINE_PROJECT_HAS_MIGRATIONS="$ESHOP_DOCTRINE_PROJECT_HAS_MIGRATIONS"
}

function get_migrations_data_path {
    local MIGRATION_PATH="$1"
    local MIGRATION_CONFIG_PATH="$2"
    local MIGRATIONS_DIR_KEY="migrations_directory"

    local DATA_PATH_SUFFIX=$(cat "$MIGRATION_CONFIG_PATH" 2>/dev/null | grep "$MIGRATIONS_DIR_KEY" | cut -d ' ' -f 2)
    local DATA_PATH=$(get_full_path_name "$MIGRATION_PATH/$DATA_PATH_SUFFIX")

    [ "$DATA_PATH" != "/" ] && echo "$DATA_PATH"
}

function has_migrations {
    local MIGRATION_DATA_PATH="$1"

    ls $MIGRATION_DATA_PATH/*.php &>/dev/null && echo 1 || echo ""
}

main
